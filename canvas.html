<!DOCTYPE html>
<html>
<head>
    <title>Sequential Movies</title>
    <script src="jquery.js"></script>
    <link href="style.css" rel="stylesheet" type="text/css" />

    
</head>
<body onload="myAddListener()">

<div id="header" style="position: relative; top: 0px">
  <canvas id="canvas" class="layer1" width="1280" height="600" 
   style="z-index: 0;"></canvas>
  <canvas id="images" class="layer1" width="1280" height="600" 
   style="z-index: 1;"></canvas>
</div>
<div id="info" style="position: relative; top:600px; left: 0px; width: 100px; float:left;">
<p>(321) VRa-tRIT</p><p>@ImagineRITVR</p><br>
</div>
<div id="footer" style="position: relative; top:600px; left: 100px; float:left;">
	<canvas id="text1" width="1280" height="50" class="layer2" 
   style="z-index: 2;"></canvas>
   	<canvas id="text2" width="1280" height="50" class="layer2" 
   style="z-index: 2;"></canvas>
</div>

    <video class="hide" id="video" controls
    src="">
    </video>
    <script type="text/javascript">

		var buff = new Array(2);
		var ttx  = new Array(2);
        var canvas = document.getElementById('canvas');
		var header = document.getElementById('header');
        var footer = document.getElementById('footer');
        var video  = document.getElementById('video');

		buff[0] = document.getElementById("text1");
		buff[1] = document.getElementById("text2");

        var started = false;
		
        var tagString = 'temp';
        var imageObj = new Image();

        var ctx    = canvas.getContext('2d');
        var itx    = images.getContext('2d');
		ttx[0]	   = buff[0].getContext("2d");
		ttx[1]	   = buff[1].getContext("2d");
		ttx[0].font = "bold 36px sans-serif";
		ttx[1].font = "bold 36px sans-serif";
		ttx[0].globalAlpha = 0.5; //
		ttx[1].globalAlpha = 0.5; //
 
        var counter = 0;
        var imageCounter = 0;
        var imageLength = 2;
		var imageTime = 15000;
        var TEXT_POS_X = 1080;
        var TEXT_POS_Y = 30;
		var VIDEO_POS_X = 0;
		var VIDEO_POS_Y = 0;
		var VIDEO_POS_SCALE_X = 0;
		var VIDEO_POS_SCALE_Y = 0;
		var canvasHeight = 1280;
		var canvasWidth = 500;
        var destWidth = 400;
        var destHeight = 400;
		var current=0;
		var startDelay = 1000;
		var staticMode = true;
		var imageCount = 1;

        function drawText() {

			buff[1- current ].style.visibility='hidden';
			buff[ current ].style.visibility='visible';
			ttx[current].font = "bold 36px sans-serif";
			var newString = '';
			if( TEXT_POS_X <=  -ttx[current].measureText(tagString).width ){
				newString = getMessage();
				while( newString == tagString ){
					newString = getMessage();
				}

				TEXT_POS_X = 1200;
			}else{
				if( tagString != 'temp' ){
					TEXT_POS_X = TEXT_POS_X - 2;
				}
			}

			if( tagString == undefined ){
		   
		   }else{
				var punct = tagString.replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()]/g,"");

				ttx[current].fillText(punct.toLowerCase(), TEXT_POS_X, TEXT_POS_Y);
		   }	

			ttx[1-current].clearRect(0,0,1280,50);
			current =1-current;
		

        }
    
        video.addEventListener('play', function () {
                  var $this = this; //cache
                  (function loop() {
                      if (!$this.paused && !$this.ended) {
                          ctx.drawImage($this, VIDEO_POS_X, VIDEO_POS_Y, VIDEO_POS_SCALED_X, VIDEO_POS_SCALED_Y);
                          setTimeout(loop, 1000 / 22); // drawing at 22fps
                      }
                  })();
              }, 0);
              
        function start(){
		  if( !started ){
			started = true;
			setTimeout(init, startDelay);
			console.log( startDelay + 's till start');
		  }
        }
		
		function init(){
			console.log('started');
			getMessage();
	        var scene = self.setInterval("drawText()",22);
            myNewSrc();
		}

		$("body").keypress(function(event) {
		  if ( event.which == 32 ) {
			 event.preventDefault();
			 start();
		   }
		  
		});
		
        // listener function changes src
        function myNewSrc() {
          counter++;
          console.log(counter);
          switch(counter){
          
            case 3:
				//e
			
              video.src="video/05.webm";
			  VIDEO_POS_X = 400;
			  VIDEO_POS_Y = 150;
			  VIDEO_POS_SCALED_X = 800;
			  VIDEO_POS_SCALED_Y = 650;
              video.load();
              video.play();
              canvas.style.display = 'block';
              break;
            case 4:        
				//d
              video.src="video/06.webm";
			  VIDEO_POS_X = 50;
			  VIDEO_POS_Y = 50;
			  VIDEO_POS_SCALED_X = 700;
			  VIDEO_POS_SCALED_Y = 400;
              video.load();
              video.play();
              canvas.style.display = 'block';
              break;
            case 6:
				//d
			  video.src="video/09.webm";
			  VIDEO_POS_X = 50;
			  VIDEO_POS_Y = 50;
			  VIDEO_POS_SCALED_X = 700;
			  VIDEO_POS_SCALED_Y = 400;
              video.load();
              video.play();
              canvas.style.display = 'block';
              break;
            case 7:
				//e
              video.src="video/10.webm";
			  VIDEO_POS_X = 400;
			  VIDEO_POS_Y = 100;
			  VIDEO_POS_SCALED_X = 800;
			  VIDEO_POS_SCALED_Y = 650;
              video.load();
              video.play();
              canvas.style.display = 'block';
              break;
            case 8:
				//d
		      //Center 
			  setTimeout(delayedCenter, 10000);
              break;
            case 9:
				//d
		      //Center 
			  setTimeout(delayedFiller, 10000);
              break;			  
			case 11:
				//e
              video.src="video/14.webm";
			  VIDEO_POS_X = 400;
			  VIDEO_POS_Y = 150;
			  VIDEO_POS_SCALED_X = 800;
			  VIDEO_POS_SCALED_Y = 650;
              video.load();
              video.play();
              canvas.style.display = 'block';
              break;
			case 12:
				//d
			  video.src="video/15.webm";
			  VIDEO_POS_X = 50;
			  VIDEO_POS_Y = 50;
			  VIDEO_POS_SCALED_X = 700;
			  VIDEO_POS_SCALED_Y = 400;
              video.load();
              video.play();
              canvas.style.display = 'block';
              break; 
			case 13:
				//d
			  video.src="video/16.webm";
			  VIDEO_POS_X = 50;
			  VIDEO_POS_Y = 50;
			  VIDEO_POS_SCALED_X = 700;
			  VIDEO_POS_SCALED_Y = 400;
              video.load();
              video.play();
              canvas.style.display = 'block';
              break;
			case 14:
				//e
              video.src="video/17.webm";
			  VIDEO_POS_X = 400;
			  VIDEO_POS_Y = 150;
			  VIDEO_POS_SCALED_X = 800;
			  VIDEO_POS_SCALED_Y = 650;
              video.load();
              video.play();
              canvas.style.display = 'block';
              break; 
            case 15:
              counter=0;
              header.style.display = 'none';
              footer.style.display = 'none';

              break;
            default:
              canvas.style.display = 'none';
              imageFilling();
              break;

          }
        }
		
		function delayedCenter(){
			  video.src="video/11.webm";
			  VIDEO_POS_X = 50;
			  VIDEO_POS_Y = 50;
			  VIDEO_POS_SCALED_X = 700;
			  VIDEO_POS_SCALED_Y = 400;
              video.load();
              video.play();
              canvas.style.display = 'block';
		}
		
		function delayedFiller(){
			//I am a magical function that does nothing but is useful
		}
        
        function imageFilling(){

          if( images.style.display == 'none' ){
            images.style.display = 'block';
          }
        
          if( imageCounter == imageLength ){
			itx.clearRect(0,0,1280,800);
            console.log('finishedWithImages');
            images.style.display = 'none';

            imageCounter=0;
            myNewSrc();
          }else{
			imageFadeOut();
            imageCounter++;
            getImage();
            setTimeout("imageFilling()",imageTime); 
          }
        }
		
		function imageFadeOut(iter, delay){
			/*
			if( iter <= 0 ){
				return;
			}
			
			while(itx.globalAlpha > 0){
				itx.globalAlpha = itx.globalAlpha - .1;
			}
			console.log( iter );
			iter--;
			setTimeout(iter, delay);
			*/
		}
		
		function imageFadeIn(iter, delay){
			/*
			if( iter <= 0 ){
				return;
			}
			
			while(itx.globalAlpha < 1){
				itx.globalAlpha = itx.globalAlpha + .1;
			}
			iter--;
			setTimeout(iter, delay);
			*/
		}
		
        
        function getImage(){
		
		  if( staticMode ){
			switch(imageCount){
				case 1:
					//b
					imageObj.src = 'video/01.jpg';
					 itx.clearRect(0,0,1280,800);
					 imageObj.onload = function(){
						itx.drawImage( imageObj, 300, 50, 600, 600 );
						imageFadeIn(10,75);
					 }
							
				break;
				case 2:
					//a
					imageObj.src = 'video/02.jpg';
					itx.clearRect(0,0,1280,800);
					imageObj.onload = function(){
						itx.drawImage( imageObj, 0, 0, 960, 720 );
						imageFadeIn(10,75);
					}
				break;
				case 3:
					//a
					imageObj.src = 'video/03.jpg';
					itx.clearRect(0,0,1280,800);
					imageObj.onload = function(){
						itx.drawImage( imageObj, 0, 0, 960, 720 ); 
						imageFadeIn(10,75);
					}
				break;
				case 4:
					//c
					imageObj.src = 'video/04.jpg';
					itx.clearRect(0,0,1280,800);
					imageObj.onload = function(){
						itx.drawImage( imageObj, 500, 100, 600, 400 );
						imageFadeIn(10,75);						
					}
				break;
				case 5:
					//c
				imageObj.src = 'video/07.jpg';
				itx.clearRect(0,0,1280,800);
					imageObj.onload = function(){
						itx.drawImage( imageObj, 500, 100, 600, 400 ); 
						imageFadeIn(10,75);
					}
				break;
				case 6:
					//a
					imageObj.src = 'video/08.jpg';
					itx.clearRect(0,0,1280,800);
					imageObj.onload = function(){
						itx.drawImage( imageObj, 0, 0, 960, 720 ); 
						imageFadeIn(10,75);
					}
				break;
				case 7:
					//a
					imageObj.src = 'video/12.jpg';
					itx.clearRect(0,0,1280,800);
					imageObj.onload = function(){
						itx.drawImage( imageObj, 0, 0, 960, 720 ); 
						imageFadeIn(10,75);
					}
				break;
				case 8:
					//b
					imageObj.src = 'video/13.jpg';
					itx.clearRect(0,0,1280,800);
					imageObj.onload = function(){
						itx.drawImage( imageObj, 300, 50, 600, 600 );
						imageFadeIn(10, 75);
					}
				break;				
				
				
			}
			imageCount++;
		  }else{
			  $.get('ajax/image.php', function(data){
				
				var val = jQuery.parseJSON(data);
				console.log(val.file);
				if( imageObj.src == 'video/'+val.file ){
				  console.log('duplicate, try again');
				  getImage();
				}else{
				 imageObj.src = 'video/'+val.file;
				 itx.clearRect(0,0,1920,800);
				 //itx.fillStyle = "rgba(255,255,255, 1)";
				 itx.fillRect(200,200,500,500);
				 //itx.drawImage( imageObj, 50, 50, destWidth, destHeight);
				}
				
				
			  });
			}
        }
        
        function getMessage(){
          $.get('ajax/tag.php', function(data){
            
            var val = jQuery.parseJSON(data);
            console.log(val.message);
            if( tagString == val.message ){
              console.log('duplicate, try again');
              getMessage();
            }else{
              tagString = val.message;
            }
            
          });
        }
        
        // add listener function to ended event -->
        function myAddListener(){
          var video = document.getElementsByTagName('video')[0];
          video.addEventListener('ended',myNewSrc,false);
        }
        
    </script>
</body>
</html>